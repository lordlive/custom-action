name: Trigger Action
description: This action triggered by a specific event.
inputs:
  workflow-ref:
    description: The reference of the workflow to trigger (tag or branch).
    required: false
    default: ${{ github.ref_name }}
  workflow-path:
    description: The path to the execute workflow file.
    required: true
  build-version:
    description: The version to be used.
    required: false
    default: ''

runs:
  using: composite
  steps:
    - name: Validate workflow file exists
      shell: bash
      run: |
        WORKFLOW_PATH="${{ inputs.workflow-path }}"
        if [ ! -f "$WORKFLOW_PATH" ]; then
          echo "âŒ Error: Workflow file does not exist: $WORKFLOW_PATH"
          exit 1
        fi
        echo "âœ… Workflow file exists: $WORKFLOW_PATH"

    - name: Check for running workflows
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        WORKFLOW_FILE=$(basename ${{ inputs.workflow-path }})
        TARGET_REF="${{ inputs.workflow-ref }}"
        TARGET_SHA=$(git rev-parse ${TARGET_REF})
        
        echo "ðŸ” Checking for active workflows with same commit SHA..."
        echo "Workflow: $WORKFLOW_FILE"
        echo "Reference: $TARGET_REF"
        echo "Target Commit SHA: $TARGET_SHA"
        
        # Check for queued workflows
        QUEUED_RUNS=$(gh run list --workflow="$WORKFLOW_FILE" --branch="$TARGET_REF" --status="queued" --json headSha,databaseId,url,status,displayTitle,createdAt 2>/dev/null || echo "[]")
        
        # Check for in_progress workflows
        IN_PROGRESS_RUNS=$(gh run list --workflow="$WORKFLOW_FILE" --branch="$TARGET_REF" --status="in_progress" --json headSha,databaseId,url,status,displayTitle,createdAt 2>/dev/null || echo "[]")
        
        # Combine both results
        ALL_ACTIVE_RUNS=$(echo "$QUEUED_RUNS $IN_PROGRESS_RUNS" | jq -s 'add | unique_by(.databaseId)')
        
        # Filter runs with matching SHA
        MATCHING_RUNS=$(echo "$ALL_ACTIVE_RUNS" | jq --arg sha "$TARGET_SHA" '[.[] | select(.headSha == $sha)]')
        MATCHING_COUNT=$(echo "$MATCHING_RUNS" | jq 'length')
        
        echo "ðŸ“Š Active Workflows Check Results:"
        echo "   Searching for commit SHA: $TARGET_SHA"
        echo "   Active workflows with matching SHA: $([ "$MATCHING_COUNT" -gt 0 ] && echo "Yes" || echo "No")"
        echo "   Active workflows count: $MATCHING_COUNT"
        echo ""
        
        if [ "$MATCHING_COUNT" -gt 0 ]; then
          echo "::warning::Found $MATCHING_COUNT active workflow run(s) for commit $TARGET_SHA"
          echo "Details:"
          
          # Display each matching workflow
          echo "$MATCHING_RUNS" | jq -r '.[] | 
            "  â€¢ Run ID: \(.databaseId)\n" +
            "    Status: \(.status)\n" +
            "    Created: \(.createdAt)\n" +
            "    URL: \(.url)\n" +
            "    Display Title: \(.displayTitle // "N/A")\n" +
            "    Head SHA: \(.headSha)\n"'
          
          echo "::warning::This may indicate a duplicate deployment. Review the existing run(s) before proceeding."
          
          # Create GitHub warning annotations for each matching workflow
          echo "$MATCHING_RUNS" | jq -r '.[] | 
            "::warning::Active run found for workflow '"$WORKFLOW_FILE"' on branch '"$TARGET_REF"' with commit '"$TARGET_SHA"': \(.url) (Status: \(.status))"'
        else
          echo "âœ… No active runs found for workflow '"$WORKFLOW_FILE"' on branch '"$TARGET_REF"' with commit '"$TARGET_SHA"' safe to run"
        fi

    - name: Trigger the workflow
      id: trigger_workflow
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh workflow run ${{ inputs.workflow-path }} --ref main --field build-version=${{ inputs.build-version }}

        # Wait a moment for the workflow to be created
        sleep 3
        
        # Get the most recent workflow run
        WORKFLOW_FILE=$(basename ${{ inputs.workflow-path }})
        RUN_DATA=$(gh run list --workflow="$WORKFLOW_FILE" --limit 1 --json databaseId,url,status,createdAt,displayTitle)
        
        if [ -n "$RUN_DATA" ]; then
          RUN_URL=$(echo "$RUN_DATA" | jq -r '.[0].url')
          RUN_ID=$(echo "$RUN_DATA" | jq -r '.[0].databaseId')
          RUN_STATUS=$(echo "$RUN_DATA" | jq -r '.[0].status')
          RUN_TITLE=$(echo "$RUN_DATA" | jq -r '.[0].displayTitle')
          
          echo "âœ… Workflow triggered successfully"
          echo "Run ID: $RUN_ID"
          echo "Run URL: $RUN_URL"
          
          # Set output
          echo "workflow-run-url=$RUN_URL" >> "$GITHUB_OUTPUT"
          
          # Create job summary
          {
            echo "## Deployment Workflow Triggered"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| **Workflow** | \`$WORKFLOW_FILE\` |"
            echo "| **Reference** | \`${{ inputs.workflow-ref }}\` |"
            echo "| **Run ID** | [\`$RUN_ID\`]($RUN_URL) |"
            echo "| **Status** | \`$RUN_STATUS\` |"
            echo "| **Title** | $RUN_TITLE |"
            echo ""
            echo "### Quick Links"
            echo "- [View Workflow Run]($RUN_URL)"
            echo "- [View All Runs](https://github.com/${{ github.repository }}/actions/workflows/$WORKFLOW_FILE)"
          } >> "$GITHUB_STEP_SUMMARY"
        else
          echo "Workflow triggered but run details could not be retrieved"
          
          # Set empty output
          echo "workflow-run-url=" >> "$GITHUB_OUTPUT"
          
          {
            echo "## Deployment Workflow Triggered"
            echo ""
            echo "| Property | Value |"
            echo "|----------|-------|"
            echo "| **Workflow** | \`$WORKFLOW_FILE\` |"
            echo "| **Reference** | \`${{ inputs.workflow-ref }}\` |"
            echo ""
            echo "Workflow triggered successfully, but run details could not be retrieved immediately."
          } >> "$GITHUB_STEP_SUMMARY"
        fi
